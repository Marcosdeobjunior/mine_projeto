<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universo de Poderes</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a2e; --surface-color: #2a2a4e; --primary-color: #00ffff;
            --secondary-color: #ff00ff; --text-color: #e0e0ff; --text-muted: #8c8ca0;
            --border-color: #4a4a7f; --glow-color: rgba(0, 255, 255, 0.5);
            --font-display: 'Roboto Condensed', sans-serif; --font-mono: 'Share Tech Mono', monospace;
            --xp-color: #FFC107; --danger-color: #ff453a; --success-color: #00ff88;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-mono); background-color: var(--bg-color); color: var(--text-color); padding: 2rem; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 1400px; }
        .btn { font-family: var(--font-display); font-size: 1.1rem; text-transform: uppercase; padding: 0.7rem 1.2rem; border: 2px solid var(--primary-color); border-radius: 4px; background-color: transparent; color: var(--primary-color); cursor: pointer; transition: all 0.2s; box-shadow: 0 0 8px var(--glow-color); }
        .btn:hover { background-color: var(--primary-color); color: var(--bg-color); }
        .btn:disabled { border-color: var(--text-muted); color: var(--text-muted); box-shadow: none; cursor: not-allowed; }
        header { text-align: center; margin-bottom: 1.5rem; }
        header h1 { font-family: var(--font-display); font-size: 2.5rem; text-transform: uppercase; color: var(--primary-color); text-shadow: 0 0 10px var(--glow-color), 0 0 20px var(--secondary-color); }
        .main-controls { display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 1rem; background-color: var(--surface-color); padding: 1rem; border-radius: 8px; margin-bottom: 2rem; border: 1px solid var(--border-color); }
        .control-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .control-group label { font-size: 0.8rem; text-align: center; color: var(--text-muted); }
        .control-group select { background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.5rem; font-family: var(--font-mono); }
        .battle-arena { display: grid; grid-template-columns: 1fr auto 1fr; gap: 2rem; align-items: flex-start; }
        .power-slot { background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; min-height: 580px; display: flex; flex-direction: column; box-shadow: 0 0 15px rgba(0,0,0,0.5); }
        .power-card { display: none; flex-direction: column; gap: 1rem; flex-grow: 1; }
        .power-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid var(--border-color); padding-bottom: 1rem; }
        .power-name { font-family: var(--font-display); font-size: 1.8rem; text-transform: uppercase; line-height: 1.2; margin-bottom: 0.5rem; }
        .power-level { font-size: 2.5rem; font-weight: bold; flex-shrink: 0; margin-left: 1rem; text-shadow: 0 0 5px var(--secondary-color); }
        .power-rarity { font-size: 1rem; font-weight: bold; padding: 5px 10px; border-radius: 4px; }
        .power-card h3 { font-family: var(--font-display); text-transform: uppercase; font-size: 1.2rem; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 5px; margin: 1rem 0 0.5rem 0; }
        .power-card ul { list-style: none; padding-left: 0; } .power-card ul li { margin-bottom: 0.5rem; line-height: 1.4; }
        .abilities-list li::before { content: '✓ '; color: var(--success-color); } .weaknesses-list li::before { content: '✗ '; color: var(--danger-color); }
        .power-actions { display: flex; gap: 1rem; margin-top: auto; }
        #battle-btn { border-color: var(--secondary-color); color: var(--secondary-color); box-shadow: 0 0 10px var(--secondary-color); }
        #battle-result { margin-top: 2rem; text-align: center; font-size: 1.2rem; font-family: var(--font-mono); min-height: 100px; line-height: 1.6; background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; white-space: pre-wrap; }
        .rarity-comum { background-color: #9E9E9E; color: #111; } .rarity-incomum { background-color: #4CAF50; color: #fff; } .rarity-raro { background-color: #2196F3; color: #fff; } .rarity-epico { background-color: #9C27B0; color: #fff; } .rarity-lendario { background-color: #FFC107; color: #111; } .rarity-mitico { border: 2px solid #fff; background: linear-gradient(45deg, #ff00ff, #00ffff); color: #fff; }
        .rarity-transcendente { border: 2px solid #FFC107; background: linear-gradient(45deg, #f0f0ff, #c0c0ff); color: #000; }
        .rarity-divino { border: 2px solid #fff; background: radial-gradient(circle, #fff, #FFD700, #ff00ff, #00ffff); color: #000; animation: divino-glow 3s ease-in-out infinite alternate; }
        @keyframes divino-glow { from { box-shadow: 0 0 10px #fff, 0 0 20px #FFD700; } to { box-shadow: 0 0 20px #00ffff, 0 0 30px #ff00ff; } }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-overlay.visible { display: flex; }
        .modal-content { background-color: var(--surface-color); padding: 2rem; border-radius: 8px; width: 90%; max-width: 1000px; max-height: 90vh; display: flex; flex-direction: column; border: 1px solid var(--border-color); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        .modal-body { overflow-y: auto; padding-right: 1rem; }
        .modal-close { background: none; border: none; color: white; font-size: 2rem; cursor: pointer; }
        .gallery-filters { display: flex; gap: 1rem; margin-bottom: 1rem; align-items: center; } .gallery-filters input, .gallery-filters select { background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.5rem; font-family: var(--font-mono); }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1rem; }
        .gallery-card { background-color: var(--bg-color); padding: 1rem; border-radius: 4px; border-left: 4px solid var(--primary-color); }
        .gallery-card-header { display: flex; justify-content: space-between; font-family: var(--font-display); font-size: 1.2rem; margin-bottom: 0.5rem; }
        .gallery-card-actions { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem; } .gallery-card-actions button { font-size: 0.8rem; padding: 0.3rem 0.6rem; border-width: 1px; }
        .xp-bar { width: 100%; height: 8px; background-color: #111; border-radius: 4px; overflow: hidden; margin: 0.5rem 0; }
        .xp-bar-fill { height: 100%; background-color: var(--xp-color); border-radius: 4px; transition: width 0.5s; }
        .character-sheet, .skill-tree, .encyclopedia-content, .item-display { display: flex; flex-direction: column; gap: 1rem; }
        .character-sheet h2, .skill-tree h2, .encyclopedia-content h2 { color: var(--primary-color); }
        .skill-choice { background-color: var(--bg-color); padding: 1rem; border-radius: 4px; margin-bottom: 0.5rem; cursor: pointer; border: 1px solid var(--border-color); }
        .skill-choice:hover { border-color: var(--primary-color); }
        .skill-choice.disabled { opacity: 0.5; cursor: not-allowed; }
        .encyclopedia-tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; } .encyclopedia-tabs button { flex-grow: 1; }
        .item-card { background-color: var(--bg-color); padding: 1rem; border-radius: 4px; text-align: center; }
        #mission-log { background-color: var(--bg-color); border: 1px solid var(--border-color); padding: 1rem; border-radius: 4px; margin-top: 1rem; }
        @media (max-width: 900px) { body { padding: 1rem; } .battle-arena { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <header><h1>Universo de Poderes</h1></header>
        <div class="main-controls">
            <div class="control-group"><label for="rarity-filter">Filtrar Raridade</label><select id="rarity-filter"><option value="any">Qualquer</option></select></div>
            <div class="control-group"><label for="domain-filter">Filtrar Domínio</label><select id="domain-filter"><option value="any">Qualquer</option></select></div>
            <button class="btn" id="generate-filtered-btn">Gerar para A</button>
            <button class="btn" data-action="open-gallery">Poderes Salvos</button>
            <button class="btn" data-action="open-encyclopedia">Enciclopédia</button>
            <button class="btn" data-action="export-gallery">Exportar</button>
            <button class="btn" data-action="import-gallery">Importar</button>
            <input type="file" id="import-file-input" style="display: none;" accept="application/json">
        </div>
        <div class="battle-arena">
            <div class="power-slot" id="power-a"><div class="power-card"><div class="power-header"><div><div class="power-name"></div><div class="power-type-tag"></div><div class="power-rarity"></div></div><div class="power-level"></div></div><p class="power-description"></p><div><h3>Habilidades</h3><ul class="abilities-list"></ul></div><div><h3>Fraquezas</h3><ul class="weaknesses-list"></ul></div></div><div class="power-actions"><button class="btn" data-action="save-power" data-slot="a" style="display:none;">Salvar</button><button class="btn generate-btn" data-slot="a">Gerar Aleatório</button></div></div>
            <div class="battle-controls"><button class="btn" id="battle-btn" disabled>Batalhar!</button></div>
            <div class="power-slot" id="power-b"><div class="power-card"><div class="power-header"><div><div class="power-name"></div><div class="power-type-tag"></div><div class="power-rarity"></div></div><div class="power-level"></div></div><p class="power-description"></p><div><h3>Habilidades</h3><ul class="abilities-list"></ul></div><div><h3>Fraquezas</h3><ul class="weaknesses-list"></ul></div></div><div class="power-actions"><button class="btn" data-action="save-power" data-slot="b" style="display:none;">Salvar</button><button class="btn generate-btn" data-slot="b">Gerar Aleatório</button></div></div>
        </div>
        <div class="battle-result" id="battle-result"></div>
    </div>
    
    <div id="gallery-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2>Galeria de Poderes Salvos</h2><div class="gallery-filters"><input type="search" id="gallery-search" placeholder="Buscar salvo..."><select id="gallery-sort"><option value="date">Mais Recentes</option><option value="level">Maior Nível</option></select></div><button class="modal-close" data-action="close-modal">&times;</button></div><div id="gallery-grid" class="gallery-grid modal-body"></div></div></div>
    <div id="character-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2>Perfil do Portador</h2><button class="modal-close" data-action="close-modal">&times;</button></div><div id="character-sheet" class="character-sheet modal-body"></div></div></div>
    <div id="evolution-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2>Árvore de Evolução</h2><button class="modal-close" data-action="close-modal">&times;</button></div><div id="skill-tree" class="skill-tree modal-body"></div></div></div>
    <div id="encyclopedia-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2>Enciclopédia</h2><button class="modal-close" data-action="close-modal">&times;</button></div><div class="encyclopedia-tabs"></div><div id="encyclopedia-content" class="encyclopedia-content modal-body"></div></div></div>
    <div id="item-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2>Equipamento</h2><button class="modal-close" data-action="close-modal">&times;</button></div><div id="item-display" class="item-display modal-body"></div></div></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- BANCO DE DADOS INTERNO ---
        const rarities = { comum: { name: 'Comum', score: 1, weight: 40 }, incomum: { name: 'Incomum', score: 2, weight: 30 }, raro: { name: 'Raro', score: 4, weight: 15 }, epico: { name: 'Épico', score: 8, weight: 9 }, lendario: { name: 'Lendário', score: 16, weight: 4 }, mitico: { name: 'Mítico', score: 32, weight: 1.5 }, transcendente: { name: 'Transcendente', score: 50, weight: 0.4 }, divino: { name: 'Divino', score: 100, weight: 0.1 } };
        const levels = { E: { name: 'E', score: 1 }, D: { name: 'D', score: 2 }, C: { name: 'C', score: 4 }, B: { name: 'B', score: 8 }, A: { name: 'A', score: 16 }, S: { name: 'S', score: 32 }, 'S+': { name: 'S+', score: 48 }, SS: { name: 'SS', score: 64 }, 'SS+': { name: 'SS+', score: 96 }, SSS: { name: 'SSS', score: 128 }, 'SSS+': { name: 'SSS+', score: 192 }, UR: { name: 'UR', score: 256 }, 'UR+': { name: 'UR+', score: 384 }, EX: { name: 'EX', score: 512 } };
        const domains = {
            fogo: { name: 'Fogo', names: ['Pirocinese', 'Coração de Magma', 'Ira do Dragão'], advantage: 'natureza', abilities: ['Gerar chamas intensas', 'Manto de fogo protetor', 'Absorver calor', 'Disparar jatos de plasma', 'Explosões de Fogo'], weaknesses: ['Vulnerável à água e frio extremo', 'Requer oxigênio para combustão', 'Pode causar incêndios acidentais', 'Pode superaquecer o próprio corpo'] },
            agua: { name: 'Água', names: ['Hidrocinese', 'Maré Viva', 'Abraço do Oceano'], advantage: 'fogo', abilities: ['Controlar corpos d\'água', 'Respirar debaixo d\'água', 'Lâminas de água pressurizada', 'Mudar estado (líquido, sólido, gasoso)', 'Cura através da água'], weaknesses: ['Vulnerável à eletricidade', 'Poder drasticamente reduzido em desertos', 'Difícil de controlar em estado gasoso'] },
            arcano: { name: 'Arcano', names: ['Magia Bruta', 'Tecelão de Feitiços', 'Corrupção Arcana'], advantage: 'gravidade', abilities: ['Manipular mana', 'Lançar feitiços de grimórios', 'Criar círculos de transmutação', 'Encantamentos'], weaknesses: ['Vulnerável a campos de anti-magia', 'Requer componentes verbais e somáticos', 'Exaustão de mana'] },
            cosmico: { name: 'Cósmico', names: ['Poeira Estelar', 'Vontade de Titã', 'Olhar do Vazio'], advantage: 'vida', abilities: ['Manipular radiação estelar', 'Criar pequenos buracos de minhoca', 'Invocar meteoros'], weaknesses: ['Poder instável e perigoso', 'Atrai atenção de entidades cósmicas'] },
            morte: { name: 'Morte', names: ['Necromancia', 'Toque Gélido', 'Ceifador de Almas'], advantage: 'natureza', abilities: ['Drenar a energia vital com o toque', 'Comunicar-se com os mortos', 'Aura de medo e decadência'], weaknesses: ['Afasta seres vivos', 'O uso constante drena a própria vitalidade', 'Ineficaz contra construtos'] },
            tecnologia: { name: 'Tecnologia', names: ['Ciber-Hacker', 'Mestre das Máquinas', 'Vontade de Metal'], advantage: 'fogo', abilities: ['Tecnopatia', 'Arsenal cibernético', 'Nanites construtores'], weaknesses: ['Vulnerável a PEM', 'Requer energia e manutenção'] },
        };
        const manifestations = {
            controle: { name: 'Controle', description: 'Manipular o domínio existente no ambiente.' }, geracao: { name: 'Geração', description: 'Criar o domínio a partir da própria energia.' },
            transformacao: { name: 'Transformação', description: 'Converter o próprio corpo ou matéria em seu domínio.' }, convocacao: { name: 'Convocação', description: 'Invocar seres ou construtos feitos de seu domínio.' },
            nulificacao: { name: 'Nulificação', description: 'Anular ou apagar a existência de seu domínio.' }
        };
        const synergyAbilities = { 'morte_convocacao': { name: 'Legião dos Caídos', text: 'Convoca um pequeno grupo de guerreiros esqueléticos para lutar ao seu lado.' } };
        const characterNames = { first: ['Aric', 'Lysandra', 'Kael', 'Seraphina', 'Orion'], last: ['da Sombra', 'do Vazio', 'Chama Solar', 'Mão de Ferro', 'Trovão'] };
        const archetypes = ['Herói relutante', 'Vilão trágico', 'Mercenário cínico', 'Guardião ancestral', 'Explorador curioso'];
        const powerOrigins = ['Acidente científico', 'Herança de linhagem sanguínea', 'Pacto com uma entidade antiga', 'Despertar sob estresse extremo', 'Artefato místico encontrado'];
        const alignments = ['Herói', 'Anti-Herói', 'Neutro', 'Anti-Vilão', 'Vilão'];
        const battleScenarios = [ { name: 'Arena Vulcânica', modifiers: { fogo: 1.2, gelo: 0.8, agua: 0.9 } }, { name: 'Cidade Cibernética', modifiers: { tecnologia: 1.3, natureza: 0.7 } }, { name: 'Floresta Arcana', modifiers: { arcano: 1.2, natureza: 1.2, tecnologia: 0.8 } }, { name: 'Vazio Cósmico', modifiers: { cosmico: 1.5, vida: 0.5 } } ];
        const itemBlueprints = { types: ['Espada', 'Anel', 'Armadura'], materials: ['de Obsidiana', 'de Metal Estelar', 'de Nanocarbono'], enchantments: { fogo: 'Flamejante', agua: 'das Marés', arcano: 'Arcano' } };
        
        let powerA = null; let powerB = null;
        const battleBtn = document.getElementById('battle-btn');
        const resultEl = document.getElementById('battle-result');
        const rarityFilter = document.getElementById('rarity-filter');
        const domainFilter = document.getElementById('domain-filter');
        const gallerySearch = document.getElementById('gallery-search');
        const gallerySort = document.getElementById('gallery-sort');

        // --- FUNÇÕES DE DADOS (LocalStorage) ---
        const getSavedPowers = () => JSON.parse(localStorage.getItem('savedPowers')) || [];
        const savePowers = (powers) => localStorage.setItem('savedPowers', JSON.stringify(powers));
        const getEpicBattles = () => JSON.parse(localStorage.getItem('epicBattles')) || [];
        const saveEpicBattles = (battles) => localStorage.setItem('epicBattles', JSON.stringify(battles));

        // --- FUNÇÕES AUXILIARES ---
        const weightedRandom = (items) => { const total = Object.values(items).reduce((s, i) => s + i.weight, 0); let r = Math.random() * total; for (const k in items) { if (r < items[k].weight) return k; r -= items[k].weight; } };
        const getRandomKey = (obj) => { const keys = Object.keys(obj); return keys[Math.floor(Math.random() * keys.length)]; };
        const getRandomSample = (arr, n) => [...arr].sort(() => 0.5 - Math.random()).slice(0, n);
        const openModal = (modalEl) => modalEl.classList.add('visible');
        const closeModal = (modalEl) => modalEl.classList.remove('visible');

        // --- LÓGICA DE GERAÇÃO DE PODER ---
        function generatePower(options = {}) {
            const rarityKey = options.rarity && options.rarity !== 'any' ? options.rarity : weightedRandom(rarities);
            const domainKey = options.domain && options.domain !== 'any' ? options.domain : getRandomKey(domains);
            let manifestationKey = getRandomKey(manifestations);
            const synergyKey = `${domainKey}_${manifestationKey}`;
            const hasSynergy = !!synergyAbilities[synergyKey];
            const rarity = rarities[rarityKey]; const domain = domains[domainKey]; const manifestation = manifestations[manifestationKey];
            const levelKeys = Object.keys(levels); let baseLevelIndex = 0;
            if (rarity.score >= 16) baseLevelIndex = 6; if (rarity.score >= 50) baseLevelIndex = 11;
            const finalLevelIndex = Math.min(baseLevelIndex + Math.floor(Math.random() * 3), levelKeys.length - 1);
            const levelKey = levelKeys[finalLevelIndex]; const level = levels[levelKey];
            let numAbilities, numWeaknesses;
            switch (rarityKey) {
                case 'comum': numAbilities = 1 + Math.floor(Math.random() * 2); numWeaknesses = 2; break;
                case 'raro': numAbilities = 2 + Math.floor(Math.random() * 2); numWeaknesses = 1; break;
                case 'lendario': numAbilities = 3 + Math.floor(Math.random() * 2); numWeaknesses = 1; break;
                default: numAbilities = 2; numWeaknesses = 2;
            }
            const finalAbilities = getRandomSample(domain.abilities, numAbilities);
            const finalWeaknesses = getRandomSample(domain.weaknesses, numWeaknesses);
            if (hasSynergy) finalAbilities.unshift(synergyAbilities[synergyKey].name);
            const powerName = getRandomSample(domain.names, 1)[0] || `${manifestation.name} de ${domain.name}`;
            const description = `Permite ao usuário ${manifestation.description.toLowerCase()} (${domain.name}).`;
            return { name: powerName, rarityKey, rarity, levelKey, level, domainKey, domain, manifestation, description, abilities: finalAbilities, weaknesses: finalWeaknesses, xp: 0, xpToNextLevel: 100, character: null, uid: Date.now() + Math.random(), equippedItem: null };
        }
        
        function renderPower(power, slot) {
            const slotEl = document.getElementById(`power-${slot}`); if (!slotEl) return;
            const cardEl = slotEl.querySelector('.power-card');
            cardEl.querySelector('.power-name').textContent = power.name;
            const typeTagEl = cardEl.querySelector('.power-type-tag');
            typeTagEl.textContent = power.domain.name; typeTagEl.className = `power-type-tag type-${power.domainKey}`;
            const rarityEl = cardEl.querySelector('.power-rarity');
            rarityEl.textContent = power.rarity.name; rarityEl.className = `power-rarity rarity-${power.rarityKey}`;
            cardEl.querySelector('.power-level').textContent = power.level.name;
            cardEl.querySelector('.power-description').textContent = power.description;
            cardEl.querySelector('.abilities-list').innerHTML = power.abilities.map(ab => `<li>${ab}</li>`).join('');
            cardEl.querySelector('.weaknesses-list').innerHTML = power.weaknesses.map(wk => `<li>${wk}</li>`).join('');
            cardEl.style.display = 'flex';
            slotEl.querySelector('[data-action="save-power"]').style.display = 'block';
        }

        // --- LÓGICA DE BATALHA E EVOLUÇÃO ---
        function battle() {
            if (!powerA || !powerB) return;
            const scenario = getRandomSample(battleScenarios, 1)[0];
            let scoreA = powerA.rarity.score * powerA.level.score * (Math.random() * 0.2 + 0.9);
            let scoreB = powerB.rarity.score * powerB.level.score * (Math.random() * 0.2 + 0.9);
            if (powerA.equippedItem) { scoreA *= powerA.equippedItem.modifier; }
            if (powerB.equippedItem) { scoreB *= powerB.equippedItem.modifier; }
            if (scenario.modifiers[powerA.domainKey]) { scoreA *= scenario.modifiers[powerA.domainKey]; }
            if (scenario.modifiers[powerB.domainKey]) { scoreB *= scenario.modifiers[powerB.domainKey]; }
            const advantageMap = Object.entries(domains).reduce((acc, [key, value]) => { acc[key] = value.advantage; return acc; }, {});
            let log = [`Cenário: ${scenario.name}!\n`, `A batalha começa! ${powerA.name} vs ${powerB.name}.`];
            if (advantageMap[powerA.domainKey] === powerB.domainKey) { scoreA *= 1.25; log.push(`${powerA.domain.name} tem vantagem sobre ${powerB.domain.name}!`); }
            else if (advantageMap[powerB.domainKey] === powerA.domainKey) { scoreB *= 1.25; log.push(`${powerB.domain.name} tem vantagem sobre ${powerA.domain.name}!`); }
            log.push(`${powerA.character ? powerA.character.name : powerA.name} ataca com '${getRandomSample(powerA.abilities, 1)[0]}'`);
            log.push(`${powerB.character ? powerB.character.name : powerB.name} responde com '${getRandomSample(powerB.abilities, 1)[0]}'`);
            let winner = null;
            if (Math.abs(scoreA - scoreB) < (scoreA + scoreB) * 0.1) { log.push("O confronto é acirrado... É um EMPATE!"); resultEl.style.color = 'var(--text-color)'; }
            else if (scoreA > scoreB) { log.push(`O poder de ${powerA.name} se sobressai! Vitória para o Combatente A!`); resultEl.style.color = 'var(--primary-color)'; winner = powerA; }
            else { log.push(`A força de ${powerB.name} é avassaladora! Vitória para o Combatente B!`); resultEl.style.color = 'var(--secondary-color)'; winner = powerB; }
            resultEl.textContent = log.join('\n');
            if (winner) awardXp(winner.uid, 50);
            if(powerA.rarity.score >= 8 && powerB.rarity.score >= 8) { const battles = getEpicBattles(); battles.unshift({log, date: new Date().toLocaleString('pt-BR')}); saveEpicBattles(battles.slice(0, 20)); }
        }
        
        function awardXp(powerUid, amount) { const savedPowers = getSavedPowers(); const p = savedPowers.find(p => p.uid === powerUid); if (!p) return; p.xp += amount; if (p.xp >= p.xpToNextLevel) { alert(`O poder "${p.name}" está pronto para evoluir!`); } savePowers(savedPowers); }
        
        // --- LÓGICA DA GALERIA E PERSONAGENS ---
        function renderGallery() {
            let savedPowers = getSavedPowers();
            const searchTerm = gallerySearch.value.toLowerCase();
            const sortBy = gallerySort.value;
            if (searchTerm) { savedPowers = savedPowers.filter(p => (p.character?.name || p.name).toLowerCase().includes(searchTerm)); }
            if (sortBy === 'level') { savedPowers.sort((a,b) => (b.rarity.score * b.level.score) - (a.rarity.score * a.level.score)); }
            const grid = document.getElementById('gallery-grid'); grid.innerHTML = '';
            if (savedPowers.length === 0) { grid.innerHTML = '<p>Nenhum poder salvo.</p>'; return; }
            savedPowers.forEach((power) => { const card = document.createElement('div'); card.className = 'gallery-card'; const xpPercent = Math.min((power.xp / power.xpToNextLevel) * 100, 100); card.innerHTML = `<div class="gallery-card-header"><span>${power.character ? power.character.name : power.name}</span><span class="rarity-${power.rarityKey}" style="padding: 2px 5px; border-radius: 3px;">${power.rarity.name} / ${power.level.name}</span></div><p>${power.character ? `${power.character.archetype} | Alinhamento: ${power.character.alignment}` : 'Sem portador'}</p><div class="xp-bar"><div class="xp-bar-fill" style="width: ${xpPercent}%"></div></div><small>${power.xp}/${power.xpToNextLevel} XP</small><div class="gallery-card-actions"><button class="btn" data-action="load-power" data-uid="${power.uid}" data-slot="a">Carregar A</button><button class="btn" data-action="load-power" data-uid="${power.uid}" data-slot="b">Carregar B</button><button class="btn" data-action="open-evolution-tree" data-uid="${power.uid}">Evoluir</button><button class="btn" data-action="open-character-profile" data-uid="${power.uid}">Perfil</button><button class="btn" data-action="delete-power" data-uid="${power.uid}">Excluir</button></div>`; grid.appendChild(card); });
        }

        function generateCharacter(powerUid) { const savedPowers = getSavedPowers(); const p = savedPowers.find(p => p.uid === powerUid); if (!p) return; p.character = { name: `${getRandomSample(characterNames.first, 1)[0]} ${getRandomSample(characterNames.last, 1)[0]}`, archetype: getRandomSample(archetypes, 1)[0], origin: getRandomSample(powerOrigins, 1)[0], alignment: getRandomSample(alignments, 1)[0] }; savePowers(savedPowers); renderCharacterProfile(p); }
        
        function renderCharacterProfile(power) {
            const sheet = document.getElementById('character-sheet');
            if (!power.character) {
                sheet.innerHTML = `<h2>Este poder ainda não tem um portador.</h2><button class="btn" data-action="generate-character-profile" data-uid="${power.uid}">Gerar Perfil Aleatório</button>`;
            } else {
                sheet.innerHTML = `
                    <h2>${power.character.name}</h2><p><strong>Arquétipo:</strong> ${power.character.archetype} | <strong>Alinhamento:</strong> ${power.character.alignment}</p>
                    <p><strong>Origem:</strong> ${power.character.origin}</p><p><strong>Equipamento:</strong> ${power.equippedItem ? power.equippedItem.name : 'Nenhum'}</p><hr>
                    <h3>Poder: ${power.name} (${power.rarity.name} / ${power.level.name})</h3><p>${power.description}</p><div id="mission-log"></div>
                    <div class="gallery-card-actions"><button class="btn" data-action="generate-mission" data-uid="${power.uid}">Gerar Missão</button><button class="btn" data-action="open-item-generator" data-uid="${power.uid}">Gerar Item</button></div>`;
            }
        }
        
        function renderEvolutionTree(power) {
            const tree = document.getElementById('skill-tree');
            tree.innerHTML = `<h2>Evolução de ${power.name}</h2><p>XP: ${power.xp}/${power.xpToNextLevel}</p>`;
            if (power.xp >= power.xpToNextLevel) {
                const levelKeys = Object.keys(levels); const i = levelKeys.indexOf(power.levelKey);
                const nextLevelKey = levelKeys[i + 1];
                tree.innerHTML += `<h3>Escolha uma melhoria:</h3><div class="skill-choice" data-action="unlock-skill" data-uid="${power.uid}" data-type="level-up" ${!nextLevelKey ? 'class="skill-choice disabled"' : ''}><strong>Aumentar Nível para ${nextLevelKey || 'MAX'}</strong><p>Aumenta a escala e o poder base.</p></div><div class="skill-choice" data-action="unlock-skill" data-uid="${power.uid}" data-type="new-ability"><strong>Nova Habilidade</strong><p>Adiciona uma nova habilidade aleatória do domínio ${power.domain.name}.</p></div>`;
            } else { tree.innerHTML += `<p>XP insuficiente para evoluir.</p>`; }
        }
        
        function unlockSkill(powerUid, type) { const savedPowers = getSavedPowers(); const p = savedPowers.find(p => p.uid == powerUid); if (!p || p.xp < p.xpToNextLevel) return; p.xp -= p.xpToNextLevel; p.xpToNextLevel = Math.round(p.xpToNextLevel * 1.5); if (type === 'level-up') { const levelKeys = Object.keys(levels); const i = levelKeys.indexOf(p.levelKey); const nextKey = levelKeys[i + 1]; if (nextKey) { p.levelKey = nextKey; p.level = levels[nextKey]; } } if (type === 'new-ability') { const newAbility = getRandomSample(p.domain.abilities.filter(a => !p.abilities.includes(a)), 1)[0]; if (newAbility) p.abilities.push(newAbility); } savePowers(savedPowers); renderEvolutionTree(p); }

        function renderEncyclopedia(tab = 'domains') { const content = document.getElementById('encyclopedia-content'); let html = '<ul>'; if (tab === 'domains') { Object.values(domains).forEach(d => { html += `<li><strong>${d.name}:</strong> Vantagem sobre ${domains[d.advantage]?.name || 'N/A'}.</li>`; }); } else if (tab === 'manifestations') { Object.values(manifestations).forEach(m => { html += `<li><strong>${m.name}:</strong> ${m.description}</li>`; }); } else if (tab === 'battles') { const battles = getEpicBattles(); if (battles.length === 0) { html += '<li>Nenhuma batalha épica registrada.</li>'; } else { battles.forEach(b => { html += `<li style="margin-bottom: 1rem;"><strong>${b.date}:</strong><br>${b.log.join('<br>')}</li>`; }); } } html += '</ul>'; content.innerHTML = html; }

        function generateAndRender(slot, options = {}) { const newPower = generatePower(options); if (slot === 'a') powerA = newPower; else powerB = newPower; renderPower(newPower, slot); resultEl.textContent = ''; battleBtn.disabled = !(powerA && powerB); }
        
        function generateItem(character) { const type = getRandomSample(itemBlueprints.types, 1)[0]; const material = getRandomSample(itemBlueprints.materials, 1)[0]; const enchantmentKey = Object.keys(itemBlueprints.enchantments).find(key => key === character.domainKey); const enchantment = enchantmentKey ? itemBlueprints.enchantments[enchantmentKey] : ''; return { name: `${type} ${enchantment} ${material}`, modifier: 1.1 }; }
        function renderItemModal(character) { const item = generateItem(character); const display = document.getElementById('item-display'); display.innerHTML = `<h2>Item Gerado</h2><div class="item-card"><h3>${item.name}</h3><p>Bônus de Poder: +10%</p></div><button class="btn" data-action="equip-item" data-uid="${character.uid}">Equipar</button>`; document.getElementById('item-modal').classList.add('visible'); }
        function generateMission(character) { const missionLog = document.getElementById('mission-log'); const missionText = `Missão para ${character.archetype}: Use seu poder de ${character.domain.name} para resolver uma crise!`; missionLog.innerHTML = `<hr><h3>Missão Atual</h3><p>${missionText}</p><button class="btn" data-action="complete-mission" data-uid="${character.uid}">Completar Missão (+200 XP)</button>`; }
        function exportGallery() { const data = JSON.stringify(getSavedPowers(), null, 2); const blob = new Blob([data], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'universo-de-poderes.json'; a.click(); URL.revokeObjectURL(url); }
        function importGallery(file) { const reader = new FileReader(); reader.onload = (e) => { try { const imported = JSON.parse(e.target.result); if(Array.isArray(imported)) { const current = getSavedPowers(); const combined = [...current, ...imported.filter(p => !current.some(cp => cp.uid === p.uid))]; savePowers(combined); showToast('Galeria importada com sucesso!', 'success'); } else { showToast('Arquivo inválido.', 'error'); } } catch(err) { showToast('Erro ao ler o arquivo.', 'error'); } }; reader.readAsText(file); }

        document.body.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]'); if (!target) return;
            const action = target.dataset.action; const slot = target.dataset.slot; const uid = parseFloat(target.dataset.uid);
            let savedPowers, power;
            switch(action) {
                case 'save-power': const powerToSave = slot === 'a' ? powerA : powerB; if (!powerToSave) return; savedPowers = getSavedPowers(); if (savedPowers.find(p => p.uid === powerToSave.uid)) { showToast('Este poder já foi salvo!', 'error'); return; } savedPowers.push(powerToSave); savePowers(savedPowers); showToast(`Poder "${powerToSave.name}" salvo!`, 'success'); break;
                case 'open-gallery': renderGallery(); document.getElementById('gallery-modal').classList.add('visible'); break;
                case 'open-encyclopedia': renderEncyclopedia(); document.getElementById('encyclopedia-modal').classList.add('visible'); break;
                case 'close-modal': target.closest('.modal-overlay').classList.remove('visible'); break;
                case 'load-power': savedPowers = getSavedPowers(); power = savedPowers.find(p => p.uid === uid); if(power) { if (slot === 'a') powerA = power; else powerB = power; renderPower(power, slot); battleBtn.disabled = !(powerA && powerB); document.getElementById('gallery-modal').classList.remove('visible'); } break;
                case 'delete-power': savedPowers = getSavedPowers(); savePowers(savedPowers.filter(p => p.uid !== uid)); renderGallery(); break;
                case 'open-character-profile': power = getSavedPowers().find(p => p.uid === uid); if (power) { renderCharacterProfile(power); document.getElementById('character-modal').classList.add('visible'); } break;
                case 'generate-character-profile': generateCharacter(uid); break;
                case 'open-evolution-tree': power = getSavedPowers().find(p => p.uid === uid); if (power) { renderEvolutionTree(power); document.getElementById('evolution-modal').classList.add('visible'); } break;
                case 'unlock-skill': unlockSkill(uid, target.dataset.type); break;
                case 'generate-mission': power = getSavedPowers().find(p => p.uid === uid); if (power) generateMission(power); break;
                case 'complete-mission': awardXp(uid, 200); document.getElementById('mission-log').innerHTML = ''; break;
                case 'open-item-generator': power = getSavedPowers().find(p => p.uid === uid); if (power) renderItemModal(power); break;
                case 'equip-item': savedPowers = getSavedPowers(); power = savedPowers.find(p => p.uid === uid); if (power) { const item = generateItem(power); power.equippedItem = item; savePowers(savedPowers); renderCharacterProfile(power); document.getElementById('item-modal').classList.remove('visible'); } break;
                case 'export-gallery': exportGallery(); break;
                case 'import-gallery': document.getElementById('import-file-input').click(); break;
            }
        });
        document.querySelectorAll('.generate-btn').forEach(btn => btn.addEventListener('click', () => generateAndRender(btn.dataset.slot)));
        document.getElementById('generate-filtered-btn').addEventListener('click', () => generateAndRender('a', { rarity: rarityFilter.value, domain: domainFilter.value }));
        battleBtn.addEventListener('click', battle);
        document.getElementById('import-file-input').addEventListener('change', (e) => { if(e.target.files[0]) importGallery(e.target.files[0]); });
        if(gallerySearch) gallerySearch.addEventListener('input', renderGallery);
        if(gallerySort) gallerySort.addEventListener('change', renderGallery);

        function populateFilters() { Object.keys(rarities).forEach(key => rarityFilter.innerHTML += `<option value="${key}">${rarities[key].name}</option>`); Object.keys(domains).forEach(key => domainFilter.innerHTML += `<option value="${key}">${domains[key].name}</option>`); }
        function initialize() {
            populateFilters();
            const encyclopediaModal = document.getElementById('encyclopedia-modal');
            const encyclopediaTabs = encyclopediaModal.querySelector('.encyclopedia-tabs');
            encyclopediaTabs.innerHTML = `<button class="btn" data-tab="domains">Domínios</button><button class="btn" data-tab="manifestations">Manifestações</button><button class="btn" data-tab="battles">Batalhas Épicas</button>`;
            encyclopediaTabs.addEventListener('click', e => { if (e.target.dataset.tab) renderEncyclopedia(e.target.dataset.tab); });
        }
        initialize();
    });
    </script>
</body>
</html>
